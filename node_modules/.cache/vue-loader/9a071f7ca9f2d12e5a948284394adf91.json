{"remainingRequest":"D:\\workCode\\xiaoE\\大圣系统源码\\admin\\node_modules\\vue-loader\\lib\\index.js??vue-loader-options!D:\\workCode\\xiaoE\\大圣系统源码\\admin\\src\\components\\order\\dialog_order_update.vue?vue&type=script&lang=js&","dependencies":[{"path":"D:\\workCode\\xiaoE\\大圣系统源码\\admin\\src\\components\\order\\dialog_order_update.vue","mtime":1677217084000},{"path":"D:\\workCode\\xiaoE\\大圣系统源码\\admin\\node_modules\\cache-loader\\dist\\cjs.js","mtime":1678778409044},{"path":"D:\\workCode\\xiaoE\\大圣系统源码\\admin\\node_modules\\babel-loader\\lib\\index.js","mtime":1678778390429},{"path":"D:\\workCode\\xiaoE\\大圣系统源码\\admin\\node_modules\\cache-loader\\dist\\cjs.js","mtime":1678778409044},{"path":"D:\\workCode\\xiaoE\\大圣系统源码\\admin\\node_modules\\vue-loader\\lib\\index.js","mtime":1678778410194}],"contextDependencies":[],"result":["\n\n  import {headers} from \"../../util/auth\";\n  import {\n    calculateMoneyStats, floatObj,\n    newOrderBills, toFixed, calculateRentLimitMoney, newVipOrderBills, isVip, calculateRentMoney\n  } from \"../../constant/goods/constant\";\n  import {getList as getExtraserviceList} from \"../../api/goods/extraservice\";\n  import {Message} from 'element-ui'\n  import {getDetail} from \"@/api/goods/goods\";\n  import {getDetail as getOrderDetail,update as updateOrder} from \"../../api/order/order\";\n  import {calcUpdateOrderBuyoutMoney} from \"../../util/order\";\n\n  export default {\n    name: 'dialog',\n    data () {\n      return {\n        param:null,\n        isShow:false,\n        loading:false,\n        dialogVisible:false,\n        editItemVisible:false,\n        billOptions:[],\n        extraServices:[],\n        goodsInfo:null,\n        addItem:{\n          status:1,\n          typeName:null,\n          money:0,\n          customId:null,\n        },\n        editIndex: 0,\n        editItem: {},\n        form:{\n          bills:[],\n          goodsId:null,\n          packageType:null,\n          lease:null,\n          moneyInfo:null,\n          money:0,\n          factPayMoney:0,\n          reductionMoney:0,\n          couponMoney:0,\n          depositMoney:0,\n        },\n        oldBills:[],\n        packageType:null,\n        goodsCombinationTitle:null,\n        packageNameTitle:null,\n        goodsCombination:null,\n        matching:true,\n        leases:[],\n        combinationsJsonData:null,\n        combinationsJsonTitles:[],\n        goodsCombinations:[],\n        imageUrl: '',\n        textarea:'',\n        option:{\n          submitBtn:false,\n          emptyBtn:false,\n          labelWidth: 120,\n          column: [\n            {label: \"选择商品\",\n              prop: \"goodsId\",\n              hide: true,\n              type: \"select\",\n              dataType: \"string\",\n              remote: true,\n              dicUrl: \"/api/blade-goods/goods/select?searchKey={{key}}\",\n              props: {\n                label: \"title\",\n                value: \"id\"\n              },\n              emitPath:false,\n              multiple: false,\n              rules: [{\n                required: true,\n                message: \"请选择商品\",\n                trigger: \"blur\"\n              }]\n            },\n            { size: 'mini',\n              label: \"规格尺寸\",\n              prop: \"combinations\",\n              type: 'select',\n              span: 12,\n              dicData:[]\n            },\n            { size: 'mini',\n              label: \"租赁方案\",\n              prop: \"packageType\",\n              type: 'select',\n              span: 12,\n              dicData:[]\n            },\n            { size: 'mini',\n              label: \"账单期数\",\n              prop: \"lease\",\n              row: true,\n              span: 12,\n              type: 'select',\n              dicData:[]\n            },\n            { size: 'mini',\n              label: \"商品价格\",\n              prop: \"goodsPrice\",\n              row: true,\n              span: 24,},\n            { size: 'mini',\n              label: \"账单项\",\n              prop: \"fistBill\",\n              row: true,\n              span: 24,},\n            { size: 'mini',\n              label: \"账单总金额\",\n              prop: \"billCount\",\n              row: true,\n              span: 24,},\n            { size: 'mini',\n              label: \"首期账单总金额\",\n              prop: \"fistBillCount\",\n              row: true,\n              span: 24,},\n            { size: 'mini',\n              label: \"首期已付总金额\",\n              prop: \"payCount\",\n              row: true,\n              span: 24,},\n            { size: 'mini',\n              label: \"首期待付金额\",\n              prop: \"noPay\",\n              row: true,\n              span: 24,}\n          ]\n        },\n\n      };\n    },\n    watch: {\n      isShow(val, oldVal) {\n      },\n      'form.bills':{\n        handler (newVal,old) {\n          Object.assign(this.form,calculateMoneyStats(this.form.bills));\n        },\n        deep:true\n      },\n      'goodsCombinationTitle': function (newVal,old) {\n        if (old){\n          this.leases = [];\n          this.form.lease = null;\n          this.form.bills = this.form.bills.filter(item => {\n            return item.status == 2 || item.status == 3;\n          });\n        }\n      },\n      'packageNameTitle': function (newVal,old) {\n        if (!this.goodsCombinationTitle||!this.combinationsJsonData)\n          return;\n        if (old){\n          this.leases = [];\n          this.form.lease = null;\n        }\n        var title = newVal+\",\"+this.goodsCombinationTitle\n        for (const item of this.combinationsJsonData) {\n          var key = item.packageName.name;\n          if (newVal != key){\n            continue;\n          }\n          for (let i = 1; i < 10; i++) {\n            if (!item['specification'+i]){\n              break;\n            }\n            if (key.length>0){\n              key = key +\",\"\n            }\n            key = key + item['specification'+i].name;\n          }\n\n          if (title == key){\n            this.goodsCombination = item;\n            this.changeRentLease(this.goodsCombination)\n            return;\n          }\n        }\n        this.form.bills = this.form.bills.filter(item => {\n          return item.status == 2 || item.status == 3;\n        });\n      },\n      'form.lease': function (newVal,old) {\n        if (this.goodsInfo){\n          this.form.bills = this.form.bills.filter(item => {\n            return item.status == 2 || item.status == 3;\n          });\n          this.oldBills = this.oldBills.filter(item => {\n            return item.status == 2 || item.status == 3;\n          });\n          this.oldBills.push(...newOrderBills(this.goodsInfo,this.goodsCombination,this.form.lease))\n          this.form.bills.push(...newOrderBills(this.goodsInfo,this.goodsCombination,this.form.lease))\n          if (this.form.goodsId == this.param.goodsId&&(this.combinationsJsonTitles.indexOf(this.goodsCombinationTitle) == -1||this.goodsCombinations.indexOf(this.packageNameTitle) == -1)){\n            console.log(\"该商品规格尺寸已改变，请重新选择规格尺寸\")\n            this.matching = false;\n          }else{\n            this.matching = true;\n          }\n        }\n      },\n      'form.goodsId': function (newVal,old) {\n        if (old){\n          this.goodsCombinationTitle = null;\n          this.leases = [];\n          this.form.lease = null;\n          this.packageNameTitle = null;\n          this.combinationsJsonTitles = [];\n          this.form.bills = this.form.bills.filter(item => {\n            return item.status == 2 || item.status == 3;\n          });\n        }\n        this.getGoodsDetail();\n      },\n    },\n    created () {\n    },\n    computed: {\n      //合约价\n      contractPrice() {\n        var money = 0;\n        var maxRate = toFixed(Number.parseFloat(this.param.totalPricesRate),2);\n        var websitePrice = toFixed(Number.parseFloat(this.param.websitePrice),2);\n        money = parseFloat(toFixed(floatObj.multiply(maxRate,websitePrice),2))\n        return money;\n      },\n      allRentBillMoney() {\n        var money = 0;\n        for (const bill of this.oldBills) {\n          if (bill.type == 5){\n            money = floatObj.add(money,Number.parseFloat(bill.money))\n          }\n        }\n        return toFixed(money,2);\n      },\n      rentBillMoney() {\n        var money = 0;\n        for (const bill of this.form.bills) {\n          if (bill.type == 5){\n            money = floatObj.add(money,Number.parseFloat(bill.money))\n          }\n        }\n        return toFixed(money,2);\n      },\n      enDistribution() {\n        var money = this.allRentBillMoney;\n        return parseFloat(toFixed(floatObj.subtract(money,this.rentBillMoney),2));\n      },\n      buyoutMoney() {\n        console.log(\"计算买断价-------\",this.form.lease,this.param)\n        if (this.form.lease&&this.param){\n          return calcUpdateOrderBuyoutMoney(this.param,this.form.bills,this.form.lease);\n        }\n        return \"~\"\n      },\n    },\n    activated () { },\n    mounted() {\n\n      console.log(process.env)\n\n      if (this.enable(\"custom_rent\")){\n        this.option.column.splice(5,0,{ size: 'mini',\n          label: \"租金分配\",\n          prop: \"rentMoney\",\n          row: true,\n          span: 24,}\n        )\n      }\n\n      this.loading = true;\n      getOrderDetail(this.param.id).then(res => {\n        this.param = res.data.data.order;\n        this.param.bills =res.data.data.bills;\n        this.param.goodsCombinationJson = JSON.parse(this.param.goodsCombinationJson)\n\n        for (const bill of this.param.bills) {\n          bill.first = false;\n          if (bill.firstBill == 2){\n            bill.first = true\n          }\n          this.form.bills.push(bill);\n        }\n        this.sort()\n        this.oldBills = JSON.parse(JSON.stringify(this.form.bills));\n\n        var key = \"\";\n        for (let i = 1; i < 10; i++) {\n          if (!this.param.goodsCombinationJson['specification'+i]){\n            break;\n          }\n          if (key.length>0){\n            key = key +\",\"\n          }\n          key = key + this.param.goodsCombinationJson['specification'+i].name;\n        }\n        this.goodsCombinationTitle = key;\n        console.log(this.goodsCombinationTitle)\n        this.form.goodsId = this.param.goodsId;\n        this.packageNameTitle = this.param.goodsCombinationJson.packageName.name;\n\n        this.form.packageType = this.param.goodsCombinationJson.packageName.type;\n        this.packageType = this.param.goodsCombinationJson.packageName.type;\n        this.form.lease = this.param.lease;\n        this.init();\n\n        this.param.goodsCombinationJson.id = this.param.goodsCombinationId\n\n        this.goodsCombination = this.param.goodsCombinationJson;\n        // this.goodsCombination.id =\n        this.changeRentLease(this.goodsCombination)\n        console.log(\"this.goodsCombination\",this.goodsCombination);\n\n        this.billOptions.unshift({label:\"溢价金\",typeName:\"溢价金\",type:4,value:4,money:this.param.goodsCombinationJson.premiumMoney})\n\n        this.billOptions.unshift({label:\"二次押金\",typeName:\"二次押金\",type:3,value:3,money:0})\n\n        getExtraserviceList(0, 100, {}).then(res => {\n          this.extraServices = res.data.data.records\n          for (const item of this.extraServices) {\n            this.billOptions.unshift({label:item.name,typeName:item.name,type:1,value:item.id,money:item.price,customId:item.id})\n          }\n          this.$nextTick(() => {\n            this.loading = false;\n          })\n        })\n      }).catch(res => {\n        this.$nextTick(() => {\n          this.loading = false;\n        })\n      })\n    },\n    methods: {\n      enItemDistribution() {\n        var money = this.allRentBillMoney;\n        var leave = toFixed(floatObj.subtract(money,this.rentBillMoney),2);\n        var leave2 = floatObj.subtract(this.editItem.money,this.editItem.newMoney?this.editItem.newMoney:0);\n        console.log(leave,leave2,parseFloat(leave)+parseFloat(leave2))\n        return toFixed(parseFloat(leave)+parseFloat(leave2),2);\n      },\n      editItemConfirm(){\n        if (this.enItemDistribution() < 0){\n          Message({\n            message: \"金额超过可设置的最大值\",\n            type: 'error'\n          })\n          return;\n        }\n        this.form.bills[this.editIndex].money = this.editItem.newMoney;\n        this.editItemVisible = false\n      },\n      autoBill() {\n        this.form.bills = this.form.bills.filter(item => {\n          return item.status == 2 || item.status == 3 || item.type != 5;\n        });\n        this.form.bills.push(...newVipOrderBills(this.goodsInfo,this.goodsCombination,this.form.lease))\n      },\n      resetBill() {\n        this.form.bills = JSON.parse(JSON.stringify(this.oldBills));\n        console.log(this.form.bills)\n      },\n      toFixed(value){\n        return toFixed(value,2)\n      },\n      calcNoPay(){\n       return toFixed(floatObj.subtract(floatObj.subtract(this.form.firstMoney,this.form.factPayMoney),this.form.couponMoney),2);\n      },\n      sort(){\n        this.$nextTick(()=>{\n          this.form.bills.sort(function(a, b){\n            var orderNumber1 = a.orderNumber?a.orderNumber:0;\n            var orderNumber2 = b.orderNumber?b.orderNumber:0;\n            var check1 = a.first;\n            var check2 = b.first;\n            if (check1&&!check2){\n              return -1;\n            }\n            if (!check1&&check2){\n              return 1;\n            }\n\n            if (check1&&check2){\n              if (orderNumber1>orderNumber2){\n                return 1;\n              }else if (orderNumber1<orderNumber2){\n                return -1;\n              }else {\n                return 0;\n              }\n            }\n\n            if (!check1&&!check2){\n              if (orderNumber1>orderNumber2){\n                return 1;\n              }else if (orderNumber1<orderNumber2){\n                return -1;\n              }else {\n                return 0;\n              }\n            }\n            return 0;\n          });\n        })\n        var _this = this;\n        this.$nextTick(()=>{\n          setTimeout(function (){\n            _this.$refs.scoll.scrollTop = 0;\n          },100)\n        })\n      },\n\n      changePackage(title){\n        console.log(title)\n      },\n      changeRentLease(item){\n        var packageName = item.packageName;\n        var mini = packageName.miniLease;\n        var max = packageName.maxLease;\n        var miniType = packageName.miniType;\n        var leaseType = miniType == \"2\"?\"个月\":\"周\";\n        this.leases = []\n        if (mini == max){\n          this.leases.push({label:mini+leaseType,value:mini})\n        }\n        if (mini != max){\n          if(this.enable('custom_rent')){\n            for (let i = mini; i <= max; i++) {\n              this.leases.push({label:i+leaseType,value:i})\n            }\n          }else {\n            this.leases.push({label:max+leaseType,value:max})\n          }\n        }\n      },\n      /**\n       * 切换规格，当切换规格的时候，分为两种情况，\n       * 第一种情况是默认的规格，这个时候resetPackageName需要为false，不重置选择的套餐\n       * 第二种情况是手动选择规格，这个时候需要触发该方法为规格下拉的点击事件。重置套餐的默认值\n       * @param title\n       * @param resetPackageName\n       */\n      changeCombinations(title,resetPackageName = true){\n        this.packageNameTitle = resetPackageName?null:this.packageNameTitle;\n        this.goodsCombinations = [];\n        for (const item of this.combinationsJsonData) {\n          var key = \"\";\n          for (let i = 1; i < 10; i++) {\n            if (!item['specification'+i]){\n              break;\n            }\n            if (key.length>0){\n              key = key +\",\"\n            }\n            key = key + item['specification'+i].name;\n          }\n          if (title == key)\n            if (this.goodsCombinations.indexOf(item.packageName.name)==-1)\n              this.goodsCombinations.push(item.packageName.name);\n        }\n      },\n      getGoodsDetail(){\n        if (!this.form.goodsId){\n          return;\n        }\n        getDetail(this.form.goodsId).then(res => {\n          this.goodsInfo = res.data.data\n          this.combinationsJsonData = JSON.parse(res.data.data.combinationsJsonData);\n          //加载套餐的下拉\n          this.changeCombinations(this.goodsCombinationTitle,false)\n          //加载规格的下拉\n          var packageName = false;\n          for (const item of this.combinationsJsonData) {\n            var key = \"\";\n            for (let i = 1; i < 10; i++) {\n              if (!item['specification'+i]){\n                break;\n              }\n              if (key.length>0){\n                key = key +\",\"\n              }\n              key = key + item['specification'+i].name;\n            }\n            if (this.combinationsJsonTitles.indexOf(key)==-1)\n              this.combinationsJsonTitles.push(key);\n            if (this.goodsCombinationTitle == key && this.packageNameTitle == item.packageName.name){\n              packageName = true;\n            }\n          }\n          //这里说明了当前订单中的商品，套餐和规格尺寸重新编辑过，导致该订单中的尺寸在商品信息中无法找到，需要重新设置\n          if (this.form.goodsId == this.param.goodsId&&(this.combinationsJsonTitles.indexOf(this.goodsCombinationTitle) == -1||!packageName)){\n            console.log(\"该商品规格尺寸已改变，请重新选择规格尺寸\")\n            this.matching = false;\n          }else{\n            this.matching = true;\n          }\n        })\n      },\n      addItemConfirm(){\n\n        if (this.addItem.money == 0){\n          Message({\n            message: \"请输入金额\",\n            type: 'error'\n          })\n          return;\n        }\n\n\n        if (!this.addItem.value){\n          Message({\n            message: \"请选择账单类型\",\n            type: 'error'\n          })\n          return;\n        }\n\n        if (parseFloat(this.param.amount)*0.9-this.form.realMoney - parseFloat(this.addItem.money)<=0){\n          var money = toFixed(parseFloat(this.param.amount)*0.9 -this.form.realMoney - parseFloat(this.addItem.money),2);\n          Message({\n            message: \"账单总金额超出了90%预授权额度的\"+(money*-1),\n            type: 'error'\n          })\n          return;\n        }\n\n        for (const bill of this.form.bills) {\n          if (bill.typeName == this.addItem.typeName&&this.addItem.type == bill.type&&bill.type == 5&&bill.orderNumber == this.addItem.orderNumber){\n            Message({\n              message: \"该账单已存在\",\n              type: 'error'\n            })\n            return;\n          }\n          if (bill.typeName == this.addItem.typeName&&this.addItem.type == bill.type&&bill.type != 5){\n            Message({\n              message: \"该账单已存在\",\n              type: 'error'\n            })\n            return;\n          }\n        }\n        this.dialogVisible = false;\n        this.addItem.first = false;\n        this.form.bills.push(this.addItem)\n        this.addItem = {\n          status:1,\n          typeName:null,\n          money:0,\n        }\n        this.sort()\n      },\n      selectItem(item){\n        Object.assign(this.addItem,item);\n      },\n      init(){\n        this.option.column[1].dicData = this.$enum.selectOpion()\n        var item = this.param.goodsCombinationJson.packageName;\n        // var item = this.$enum.defaultPlanInfo['type_'+this.form.packageType];\n        var mini = item.miniLease;\n        var max = item.maxLease;\n        var miniType = item.miniType;\n        var leaseType = miniType == \"2\"?\"个月\":\"周\";\n        if (mini == max){\n          this.option.column[2].dicData.push({label:mini+leaseType,value:mini})\n        }\n        if (mini != max){\n          for (let i = mini; i <= max; i++) {\n            this.option.column[2].dicData.push({label:i+leaseType,value:i})\n          }\n        }\n      },\n      deleteBill(index){\n        this.form.bills.splice(index,1);\n      },\n      addBill(){\n        this.dialogVisible = true;\n      },\n      editBill(index){\n        this.editItemVisible = true;\n        this.editIndex = index;\n        this.editItem = {...this.form.bills[index]};\n      },\n      /**\n       * 提交编辑\n       */\n      submit(){\n        //提交之前，先对订单进行整理\n        const order = {};\n        order.goodsCombination = JSON.stringify(this.goodsCombination)\n        order.bills = this.form.bills;\n        for (const bill of order.bills) {\n          if (bill.first){\n            bill.firstBill = 2;\n          }else {\n            bill.firstBill = 1;\n          }\n        }\n        order.goodsCombinationId = this.goodsCombination.id;\n        order.goodsId = this.form.goodsId;\n        order.id = this.param.id;\n        order.no = this.param.no;//订单编号\n        order.goodsTitle = this.goodsInfo.title//商品名称\n        order.secondHand = this.goodsInfo.secondHand;//折扣率\n        order.lease = this.form.lease;//周期\n        order.leaseType = this.goodsCombination.packageName.miniType;//周期类型\n        order.rentType = this.goodsCombination.packageName.type;//套餐类型\n        order.websitePrice = Number.parseFloat(this.goodsCombination.websitePrice);//官网价\n        order.totalPricesRate = Number.parseFloat(this.goodsInfo.totalPricesRate);//总价系数\n        order.rentPerMoney = Number.parseFloat(this.goodsCombination.rentPerMoney);//每一期租金\n        order.depositMoneyFirst = Number.parseFloat(this.goodsCombination.depositMoney);//商品押金\n        this.goodsCombination.totalPricesRate = order.totalPricesRate;\n        if (order.rentType == 1||order.rentType==2){\n          order.rentMoney = calculateRentMoney(this.goodsCombination)\n        }else{\n          order.rentMoney = calculateRentLimitMoney(this.goodsCombination,order.lease)\n        }\n        this.loading = true;\n        updateOrder(order).then(res => {\n          console.log(res)\n          this.loading = false;\n          this.isShow = false\n          this.$nextTick(() => {\n            this.end(true);\n          })\n        }).catch(res => {\n          console.log(res)\n          this.loading = false;\n        });\n      },\n      cancle(){\n        this.isShow = false\n        this.$nextTick(() => {\n          this.end(false);\n        })\n      },\n      headers(){\n        return headers()\n      },\n      closeFn () {\n        this.isShow = false\n        this.$nextTick(() => {\n          this.end(false);\n        })\n      },\n      billTypeName(bill){\n        if (bill.type == 5){\n          return \"第\"+bill.orderNumber+bill.typeName;\n        }\n        return bill.typeName;\n      },\n      handleAvatarSuccess(res, file) {\n        this.imageUrl = URL.createObjectURL(file.raw);\n      },\n      beforeAvatarUpload(file) {\n        const isJPG = file.type === 'image/jpeg';\n        const isLt2M = file.size / 1024 / 1024 < 2;\n\n        if (!isJPG) {\n          this.$message.error('上传头像图片只能是 JPG 格式!');\n        }\n        if (!isLt2M) {\n          this.$message.error('上传头像图片大小不能超过 2MB!');\n        }\n        return isJPG && isLt2M;\n      }\n    },\n  };\n",{"version":3,"sources":["dialog_order_update.vue"],"names":[],"mappings":";;AAkRA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;;AAEA;;AAEA;AACA;AACA;AACA;;AAEA;;AAEA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;;;AAGA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA","file":"dialog_order_update.vue","sourceRoot":"src/components/order","sourcesContent":["<!--\n 订单修改\n -->\n<template>\n  <div style=\"height: 100%;\">\n    <el-dialog\n      v-if=\"isShow\"\n      v-model=\"form\"\n      title=\"订单修改\"\n      :visible.sync=\"isShow\"\n      width=\"800px\"\n      @close=\"closeFn\"\n      append-to-body\n      style=\"text-align: left\">\n      <div style=\"width: 100%;min-height:300px;height: 100%;position: relative;\">\n        <div v-loading=\"loading\"  element-loading-text=\"拼命加载中\" style=\"height:100%;width:100%;z-index: 100;position: absolute\" v-if=\"loading\"></div>\n        <div style=\"height: 100%\">\n          <div style=\"width: 100%;text-align: center;margin-bottom: 10px\" v-if=\"!matching\">\n            <el-alert\n              :closable=\"false\"\n              title=\"该商品规格尺寸已改变，请重新选择规格尺寸\"\n              type=\"warning\">\n            </el-alert>\n          </div>\n          <avue-form ref=\"form\" class=\"bill_info\" v-model=\"form\" :option=\"option\" @submit=\"submit\" @reset-change=\"cancle\">\n            <template slot-scope=\"{disabled,size}\" slot=\"fistBill\">\n              <div style=\"width: 100%\">\n                <div class=\"bills myscollbar\" ref=\"scoll\">\n                  <template v-for=\"(bill,index) in form.bills\">\n                    <div style=\"display: inline-flex;margin-bottom: 5px\">\n                      <div style=\"display: inline-flex;background-color: #eeeeee80;border-radius: 5px;padding: 0px 5px;flex: 1;justify-content: space-between\">\n                        <div style=\"margin-left: 10px\">\n                          <span style=\"width: 120px;text-align: right\">{{ billTypeName(bill) }}：</span>\n                          <span>\n                            {{ bill.money }}\n                            <span v-if=\"bill.status == 2 || bill.status == 3\">（已付：{{bill.factPayMoney}}）</span>\n                            <span v-if=\"bill.status == 2 || bill.status == 3\" style=\"font-size: 14px;\" >（已减免：{{bill.reductionMoney}}）</span>\n                            <span style=\"font-size: 14px;\" v-if=\"bill.couponMoney&&bill.couponMoney!=0\">（优惠券：{{bill.couponMoney}}）</span>\n                          </span>\n                        </div>\n                        <el-checkbox v-model=\"bill.first\" @change=\"sort\" :disabled=\"bill.status == 2 || bill.status == 3\">首次支付</el-checkbox>\n                      </div>\n                      <div style=\"margin-left: 10px;width: 20px;cursor: pointer\">\n                        <template v-if=\"bill.type != 5 && bill.status == 1 \">\n                          <el-popconfirm\n                            title=\"确认删除该账单吗？\"\n                            @confirm='deleteBill(index)'>\n                            <i class=\"el-icon-delete\"  slot=\"reference\" ></i>\n                          </el-popconfirm>\n                        </template>\n                        <i class=\"el-icon-edit-outline\"  @click=\"editBill(index)\" v-if=\"bill.type == 5 && form.lease == 12 && enable('custom_rent')\"></i>\n                      </div>\n                    </div>\n                  </template>\n                </div>\n                <div style=\"display: inline-flex;width: 100%\">\n                  <div style=\"border-radius: 5px;padding: 0px 5px;flex: 1;border: 1px solid #eeeeee;text-align: center;cursor: pointer;margin-top: 5px\" v-if=\"form.lease\" @click=\"addBill\">\n                    添加收费项\n                  </div>\n                  <span v-else style=\"font-size: 13px;color: red\">\n                  暂无账单，请完整选择商品，规格，套餐，租期\n                </span>\n\n                </div>\n              </div>\n            </template>\n\n            <template slot-scope=\"{disabled,size}\" slot=\"rentMoney\">\n              <div style=\"width: 100%;display: inline-flex\">\n                <el-descriptions class=\"margin-top\"  :column=\"4\" style=\"flex: 1\" border size=\"mini\">\n                  <el-descriptions-item label-class-name=\"title-class\" >\n                    <template slot=\"label\">\n                      {{ form.lease }}期租金\n                    </template>\n                    {{allRentBillMoney}}\n                  </el-descriptions-item>\n                  <el-descriptions-item label-class-name=\"title-class\" >\n                    <template slot=\"label\">\n                      已分配\n                    </template>\n                    {{rentBillMoney}}\n                  </el-descriptions-item>\n                  <el-descriptions-item label-class-name=\"title-class\" >\n                    <template slot=\"label\">\n                      可分配\n                    </template>\n                    <div style=\"color: #dd6161\">{{enDistribution}}</div>\n                  </el-descriptions-item>\n                  <el-descriptions-item label-class-name=\"title-class\" >\n                    <template slot=\"label\">\n                      授信额度\n                    </template>\n                    <div style=\"color: #dd6161\">{{param.amount}}</div>\n                  </el-descriptions-item>\n                </el-descriptions>\n                <div style=\"display: inline-flex;margin-left: 5px\" v-if=\"enable('custom_rent')\">\n                  <el-button size=\"mini\" @click=\"resetBill\">重置</el-button>\n                  <el-tooltip class=\"item\" effect=\"dark\" placement=\"top-start\">\n                    <div slot=\"content\">前6期是（合约价 * 0.838 / 6）<br/>后6期就是（合约价 - 前面6个月的总价）/6</div>\n                    <el-button size=\"mini\" style=\"margin-left: 5px\" @click=\"autoBill\">自动</el-button>\n                  </el-tooltip>\n                </div>\n              </div>\n            </template>\n\n            <template slot-scope=\"{disabled,size}\" slot=\"goodsPrice\">\n              <el-descriptions class=\"margin-top\"  :column=\"5\" border size=\"mini\">\n                <el-descriptions-item label-class-name=\"title-class\" >\n                  <template slot=\"label\">\n                    官网价\n                  </template>\n                  {{goodsCombination?goodsCombination.websitePrice:\"\"}}\n                </el-descriptions-item>\n                <el-descriptions-item label-class-name=\"title-class\" >\n                  <template slot=\"label\">\n                    合约价\n                  </template>\n                  {{contractPrice}}\n                </el-descriptions-item>\n                <el-descriptions-item label-class-name=\"title-class\" >\n                  <template slot=\"label\">\n                    租金系数\n                  </template>\n                  {{goodsCombination?goodsCombination.rentRate:\"\"}}\n                </el-descriptions-item>\n                <el-descriptions-item label-class-name=\"title-class\" >\n                  <template slot=\"label\">\n                    每期租金\n                  </template>\n                  {{goodsCombination?goodsCombination.rentPerMoney:\"\"}}\n                </el-descriptions-item>\n                <el-descriptions-item label-class-name=\"title-class\" >\n                  <template slot=\"label\">\n                    买断价\n                    <el-tooltip class=\"item\" effect=\"dark\" placement=\"left\">\n                      <div slot=\"content\">买断价：<br/>\n                        增长幅度公式： A = （总价系数 - 1.255）/ 3<br/>\n                        第4个月系数：1.25 + A<br/>\n                        第5个月系数：1.25 + A * 2<br/>\n                        第6个月系数：1.25 + A * 3<br/>\n                        后面6到12个月买断系数都和第6个月一样</div>\n                      <i class=\"el-icon-warning-outline\" style=\"color: #dd6161\"></i>\n                    </el-tooltip>\n                  </template>\n                  {{buyoutMoney}}\n                </el-descriptions-item>\n              </el-descriptions>\n            </template>\n            <template slot-scope=\"{disabled,size}\" slot=\"combinations\">\n              <el-select v-model=\"goodsCombinationTitle\" placeholder=\"请选择规格尺寸\" size=\"mini\">\n                <el-option\n                  v-for=\"(item, index) in combinationsJsonTitles\"\n                  :key=\"index\"\n                  @click.native =\"changeCombinations(item)\"\n                  :label=\"item\"\n                  :value=\"item\">\n                </el-option>\n              </el-select>\n            </template>\n            <template slot-scope=\"{disabled,size}\" slot=\"packageType\">\n              <el-select v-model=\"packageNameTitle\" placeholder=\"请选择租赁方案\" size=\"mini\">\n                <el-option\n                  v-for=\"(item, index) in goodsCombinations\"\n                  :key=\"index\"\n                  @click.native =\"changePackage(item)\"\n                  :label=\"item\"\n                  :value=\"item\">\n                </el-option>\n              </el-select>\n            </template>\n\n            <template slot-scope=\"{disabled,size}\" slot=\"lease\">\n              <el-select v-model=\"form.lease\" placeholder=\"请选择期数\" size=\"mini\">\n                <el-option\n                  v-for=\"(item, index) in leases\"\n                  :key=\"item.value\"\n                  :label=\"item.label\"\n                  :value=\"item.value\">\n                </el-option>\n              </el-select>\n            </template>\n            <template slot-scope=\"{disabled,size}\" slot=\"fistBillCount\">\n              <span style=\"font-weight: bold;font-size: 20px;\">{{toFixed(form.firstMoney)}}</span>\n            </template>\n\n            <template slot-scope=\"{disabled,size}\" slot=\"billCount\">\n              <span style=\"font-weight: bold;font-size: 20px;\">{{toFixed(form.realMoney)}}</span>\n              <span v-if=\"param.amount-form.realMoney>=0\">\n                (距离支付宝预授权额度：<span>{{param.amount}}的90%({{toFixed(parseFloat(param.amount)*0.9,2)}}\n                    <el-tooltip class=\"item\" effect=\"dark\" content=\"账单总金额不能超过支付宝授信额度的90%\" placement=\"top-start\">\n                          <i class=\"el-icon-warning-outline\" style=\"color: #dd6161\"></i>\n                    </el-tooltip>\n                )</span>，还有<span>{{toFixed(parseFloat(param.amount)*0.9-form.realMoney,2)}}</span>扣费额度)\n              </span>\n              <span v-else style=\"color: #dd6161\">\n                 (超过支付宝预授权额度：<span>{{param.amount}}的80%({{parseFloat(param.amount)*0.9}}\n                  <el-tooltip class=\"item\" effect=\"dark\" content=\"账单总金额不能超过支付宝授信额度的90%\" placement=\"top-start\">\n                          <i class=\"el-icon-warning-outline\" style=\"color: #dd6161\"></i>\n                    </el-tooltip>\n                )</span>，超出金额为<span>{{parseFloat(param.amount)*0.9-form.realMoney}}</span>)\n              </span>\n            </template>\n\n            <template slot-scope=\"{disabled,size}\" slot=\"payCount\">\n              <span style=\"font-weight: bold;font-size: 20px;color: #67c23a\">{{toFixed(form.factPayMoney)}}<span v-if=\"form.reductionMoney && form.reductionMoney >0\" style=\"font-size: 14px;\">(实付<span>{{form.realPay}}</span><span style=\"color: #dd6161;margin-left: 4px\">减免{{form.reductionMoney}}</span>)</span></span>\n            </template>\n\n            <template slot-scope=\"{disabled,size}\" slot=\"noPay\">\n              <span style=\"font-weight: bold;font-size: 20px;color: red\">{{calcNoPay()}}</span>\n            </template>\n            <template slot-scope=\"{size}\" slot=\"menuForm\">\n              <div slot=\"footer\" class=\"dialog-footer\" style=\"text-align: end;\">\n                <el-button size=\"medium\" @click=\"$refs.form.resetForm()\">取 消</el-button>\n                <el-button size=\"medium\" type=\"primary\"  @click=\"$refs.form.submit()\">确 定</el-button>\n              </div>\n            </template>\n          </avue-form>\n        </div>\n      </div>\n    </el-dialog>\n    <el-dialog\n      title=\"选择账单\"\n      :close-on-click-modal=\"false\"\n      :visible.sync=\"dialogVisible\"\n      width=\"30%\">\n      <div>\n        <div style=\"display: flex\">\n          <span>账单类型：</span>\n          <el-select v-model=\"addItem.typeName\" style=\"flex: 1\" size=\"mini\" placeholder=\"请选择\">\n            <el-option\n              @click.native =\"selectItem(item)\"\n              v-for=\"item in billOptions\"\n              :key=\"item.value\"\n              :label=\"item.label\"\n              :value=\"item.label\">\n            </el-option>\n          </el-select>\n        </div>\n        <div style=\"display: flex;margin-top: 10px\">\n          <span>账单金额：</span>\n          <el-input v-model=\"addItem.money\" size=\"mini\" style=\"flex: 1\" placeholder=\"请输入内容\"></el-input>\n        </div>\n      </div>\n      <span slot=\"footer\" class=\"dialog-footer\">\n        <el-button @click=\"dialogVisible = false\">取 消</el-button>\n        <el-button type=\"primary\" @click=\"addItemConfirm\">确 定</el-button>\n      </span>\n    </el-dialog>\n\n    <el-dialog\n      title=\"编辑账单\"\n      :close-on-click-modal=\"false\"\n      :visible.sync=\"editItemVisible\"\n      width=\"30%\">\n      <div>\n        <div style=\"display: flex\">\n          <span>可增加金额：</span>\n          <span>{{enItemDistribution()}}</span>\n        </div>\n        <div style=\"display: flex;margin-top: 10px\">\n          <span>账单金额：</span>\n          <el-input v-model=\"editItem.newMoney\" size=\"mini\" style=\"flex: 1\" placeholder=\"请输入内容\"></el-input>\n        </div>\n        <div> <span></span></div>\n      </div>\n      <span slot=\"footer\" class=\"dialog-footer\">\n        <el-button @click=\"editItemVisible = false\">取 消</el-button>\n        <el-button type=\"primary\" @click=\"editItemConfirm\">确 定</el-button>\n      </span>\n    </el-dialog>\n  </div>\n</template>\n<script>\n\n  import {headers} from \"../../util/auth\";\n  import {\n    calculateMoneyStats, floatObj,\n    newOrderBills, toFixed, calculateRentLimitMoney, newVipOrderBills, isVip, calculateRentMoney\n  } from \"../../constant/goods/constant\";\n  import {getList as getExtraserviceList} from \"../../api/goods/extraservice\";\n  import {Message} from 'element-ui'\n  import {getDetail} from \"@/api/goods/goods\";\n  import {getDetail as getOrderDetail,update as updateOrder} from \"../../api/order/order\";\n  import {calcUpdateOrderBuyoutMoney} from \"../../util/order\";\n\n  export default {\n    name: 'dialog',\n    data () {\n      return {\n        param:null,\n        isShow:false,\n        loading:false,\n        dialogVisible:false,\n        editItemVisible:false,\n        billOptions:[],\n        extraServices:[],\n        goodsInfo:null,\n        addItem:{\n          status:1,\n          typeName:null,\n          money:0,\n          customId:null,\n        },\n        editIndex: 0,\n        editItem: {},\n        form:{\n          bills:[],\n          goodsId:null,\n          packageType:null,\n          lease:null,\n          moneyInfo:null,\n          money:0,\n          factPayMoney:0,\n          reductionMoney:0,\n          couponMoney:0,\n          depositMoney:0,\n        },\n        oldBills:[],\n        packageType:null,\n        goodsCombinationTitle:null,\n        packageNameTitle:null,\n        goodsCombination:null,\n        matching:true,\n        leases:[],\n        combinationsJsonData:null,\n        combinationsJsonTitles:[],\n        goodsCombinations:[],\n        imageUrl: '',\n        textarea:'',\n        option:{\n          submitBtn:false,\n          emptyBtn:false,\n          labelWidth: 120,\n          column: [\n            {label: \"选择商品\",\n              prop: \"goodsId\",\n              hide: true,\n              type: \"select\",\n              dataType: \"string\",\n              remote: true,\n              dicUrl: \"/api/blade-goods/goods/select?searchKey={{key}}\",\n              props: {\n                label: \"title\",\n                value: \"id\"\n              },\n              emitPath:false,\n              multiple: false,\n              rules: [{\n                required: true,\n                message: \"请选择商品\",\n                trigger: \"blur\"\n              }]\n            },\n            { size: 'mini',\n              label: \"规格尺寸\",\n              prop: \"combinations\",\n              type: 'select',\n              span: 12,\n              dicData:[]\n            },\n            { size: 'mini',\n              label: \"租赁方案\",\n              prop: \"packageType\",\n              type: 'select',\n              span: 12,\n              dicData:[]\n            },\n            { size: 'mini',\n              label: \"账单期数\",\n              prop: \"lease\",\n              row: true,\n              span: 12,\n              type: 'select',\n              dicData:[]\n            },\n            { size: 'mini',\n              label: \"商品价格\",\n              prop: \"goodsPrice\",\n              row: true,\n              span: 24,},\n            { size: 'mini',\n              label: \"账单项\",\n              prop: \"fistBill\",\n              row: true,\n              span: 24,},\n            { size: 'mini',\n              label: \"账单总金额\",\n              prop: \"billCount\",\n              row: true,\n              span: 24,},\n            { size: 'mini',\n              label: \"首期账单总金额\",\n              prop: \"fistBillCount\",\n              row: true,\n              span: 24,},\n            { size: 'mini',\n              label: \"首期已付总金额\",\n              prop: \"payCount\",\n              row: true,\n              span: 24,},\n            { size: 'mini',\n              label: \"首期待付金额\",\n              prop: \"noPay\",\n              row: true,\n              span: 24,}\n          ]\n        },\n\n      };\n    },\n    watch: {\n      isShow(val, oldVal) {\n      },\n      'form.bills':{\n        handler (newVal,old) {\n          Object.assign(this.form,calculateMoneyStats(this.form.bills));\n        },\n        deep:true\n      },\n      'goodsCombinationTitle': function (newVal,old) {\n        if (old){\n          this.leases = [];\n          this.form.lease = null;\n          this.form.bills = this.form.bills.filter(item => {\n            return item.status == 2 || item.status == 3;\n          });\n        }\n      },\n      'packageNameTitle': function (newVal,old) {\n        if (!this.goodsCombinationTitle||!this.combinationsJsonData)\n          return;\n        if (old){\n          this.leases = [];\n          this.form.lease = null;\n        }\n        var title = newVal+\",\"+this.goodsCombinationTitle\n        for (const item of this.combinationsJsonData) {\n          var key = item.packageName.name;\n          if (newVal != key){\n            continue;\n          }\n          for (let i = 1; i < 10; i++) {\n            if (!item['specification'+i]){\n              break;\n            }\n            if (key.length>0){\n              key = key +\",\"\n            }\n            key = key + item['specification'+i].name;\n          }\n\n          if (title == key){\n            this.goodsCombination = item;\n            this.changeRentLease(this.goodsCombination)\n            return;\n          }\n        }\n        this.form.bills = this.form.bills.filter(item => {\n          return item.status == 2 || item.status == 3;\n        });\n      },\n      'form.lease': function (newVal,old) {\n        if (this.goodsInfo){\n          this.form.bills = this.form.bills.filter(item => {\n            return item.status == 2 || item.status == 3;\n          });\n          this.oldBills = this.oldBills.filter(item => {\n            return item.status == 2 || item.status == 3;\n          });\n          this.oldBills.push(...newOrderBills(this.goodsInfo,this.goodsCombination,this.form.lease))\n          this.form.bills.push(...newOrderBills(this.goodsInfo,this.goodsCombination,this.form.lease))\n          if (this.form.goodsId == this.param.goodsId&&(this.combinationsJsonTitles.indexOf(this.goodsCombinationTitle) == -1||this.goodsCombinations.indexOf(this.packageNameTitle) == -1)){\n            console.log(\"该商品规格尺寸已改变，请重新选择规格尺寸\")\n            this.matching = false;\n          }else{\n            this.matching = true;\n          }\n        }\n      },\n      'form.goodsId': function (newVal,old) {\n        if (old){\n          this.goodsCombinationTitle = null;\n          this.leases = [];\n          this.form.lease = null;\n          this.packageNameTitle = null;\n          this.combinationsJsonTitles = [];\n          this.form.bills = this.form.bills.filter(item => {\n            return item.status == 2 || item.status == 3;\n          });\n        }\n        this.getGoodsDetail();\n      },\n    },\n    created () {\n    },\n    computed: {\n      //合约价\n      contractPrice() {\n        var money = 0;\n        var maxRate = toFixed(Number.parseFloat(this.param.totalPricesRate),2);\n        var websitePrice = toFixed(Number.parseFloat(this.param.websitePrice),2);\n        money = parseFloat(toFixed(floatObj.multiply(maxRate,websitePrice),2))\n        return money;\n      },\n      allRentBillMoney() {\n        var money = 0;\n        for (const bill of this.oldBills) {\n          if (bill.type == 5){\n            money = floatObj.add(money,Number.parseFloat(bill.money))\n          }\n        }\n        return toFixed(money,2);\n      },\n      rentBillMoney() {\n        var money = 0;\n        for (const bill of this.form.bills) {\n          if (bill.type == 5){\n            money = floatObj.add(money,Number.parseFloat(bill.money))\n          }\n        }\n        return toFixed(money,2);\n      },\n      enDistribution() {\n        var money = this.allRentBillMoney;\n        return parseFloat(toFixed(floatObj.subtract(money,this.rentBillMoney),2));\n      },\n      buyoutMoney() {\n        console.log(\"计算买断价-------\",this.form.lease,this.param)\n        if (this.form.lease&&this.param){\n          return calcUpdateOrderBuyoutMoney(this.param,this.form.bills,this.form.lease);\n        }\n        return \"~\"\n      },\n    },\n    activated () { },\n    mounted() {\n\n      console.log(process.env)\n\n      if (this.enable(\"custom_rent\")){\n        this.option.column.splice(5,0,{ size: 'mini',\n          label: \"租金分配\",\n          prop: \"rentMoney\",\n          row: true,\n          span: 24,}\n        )\n      }\n\n      this.loading = true;\n      getOrderDetail(this.param.id).then(res => {\n        this.param = res.data.data.order;\n        this.param.bills =res.data.data.bills;\n        this.param.goodsCombinationJson = JSON.parse(this.param.goodsCombinationJson)\n\n        for (const bill of this.param.bills) {\n          bill.first = false;\n          if (bill.firstBill == 2){\n            bill.first = true\n          }\n          this.form.bills.push(bill);\n        }\n        this.sort()\n        this.oldBills = JSON.parse(JSON.stringify(this.form.bills));\n\n        var key = \"\";\n        for (let i = 1; i < 10; i++) {\n          if (!this.param.goodsCombinationJson['specification'+i]){\n            break;\n          }\n          if (key.length>0){\n            key = key +\",\"\n          }\n          key = key + this.param.goodsCombinationJson['specification'+i].name;\n        }\n        this.goodsCombinationTitle = key;\n        console.log(this.goodsCombinationTitle)\n        this.form.goodsId = this.param.goodsId;\n        this.packageNameTitle = this.param.goodsCombinationJson.packageName.name;\n\n        this.form.packageType = this.param.goodsCombinationJson.packageName.type;\n        this.packageType = this.param.goodsCombinationJson.packageName.type;\n        this.form.lease = this.param.lease;\n        this.init();\n\n        this.param.goodsCombinationJson.id = this.param.goodsCombinationId\n\n        this.goodsCombination = this.param.goodsCombinationJson;\n        // this.goodsCombination.id =\n        this.changeRentLease(this.goodsCombination)\n        console.log(\"this.goodsCombination\",this.goodsCombination);\n\n        this.billOptions.unshift({label:\"溢价金\",typeName:\"溢价金\",type:4,value:4,money:this.param.goodsCombinationJson.premiumMoney})\n\n        this.billOptions.unshift({label:\"二次押金\",typeName:\"二次押金\",type:3,value:3,money:0})\n\n        getExtraserviceList(0, 100, {}).then(res => {\n          this.extraServices = res.data.data.records\n          for (const item of this.extraServices) {\n            this.billOptions.unshift({label:item.name,typeName:item.name,type:1,value:item.id,money:item.price,customId:item.id})\n          }\n          this.$nextTick(() => {\n            this.loading = false;\n          })\n        })\n      }).catch(res => {\n        this.$nextTick(() => {\n          this.loading = false;\n        })\n      })\n    },\n    methods: {\n      enItemDistribution() {\n        var money = this.allRentBillMoney;\n        var leave = toFixed(floatObj.subtract(money,this.rentBillMoney),2);\n        var leave2 = floatObj.subtract(this.editItem.money,this.editItem.newMoney?this.editItem.newMoney:0);\n        console.log(leave,leave2,parseFloat(leave)+parseFloat(leave2))\n        return toFixed(parseFloat(leave)+parseFloat(leave2),2);\n      },\n      editItemConfirm(){\n        if (this.enItemDistribution() < 0){\n          Message({\n            message: \"金额超过可设置的最大值\",\n            type: 'error'\n          })\n          return;\n        }\n        this.form.bills[this.editIndex].money = this.editItem.newMoney;\n        this.editItemVisible = false\n      },\n      autoBill() {\n        this.form.bills = this.form.bills.filter(item => {\n          return item.status == 2 || item.status == 3 || item.type != 5;\n        });\n        this.form.bills.push(...newVipOrderBills(this.goodsInfo,this.goodsCombination,this.form.lease))\n      },\n      resetBill() {\n        this.form.bills = JSON.parse(JSON.stringify(this.oldBills));\n        console.log(this.form.bills)\n      },\n      toFixed(value){\n        return toFixed(value,2)\n      },\n      calcNoPay(){\n       return toFixed(floatObj.subtract(floatObj.subtract(this.form.firstMoney,this.form.factPayMoney),this.form.couponMoney),2);\n      },\n      sort(){\n        this.$nextTick(()=>{\n          this.form.bills.sort(function(a, b){\n            var orderNumber1 = a.orderNumber?a.orderNumber:0;\n            var orderNumber2 = b.orderNumber?b.orderNumber:0;\n            var check1 = a.first;\n            var check2 = b.first;\n            if (check1&&!check2){\n              return -1;\n            }\n            if (!check1&&check2){\n              return 1;\n            }\n\n            if (check1&&check2){\n              if (orderNumber1>orderNumber2){\n                return 1;\n              }else if (orderNumber1<orderNumber2){\n                return -1;\n              }else {\n                return 0;\n              }\n            }\n\n            if (!check1&&!check2){\n              if (orderNumber1>orderNumber2){\n                return 1;\n              }else if (orderNumber1<orderNumber2){\n                return -1;\n              }else {\n                return 0;\n              }\n            }\n            return 0;\n          });\n        })\n        var _this = this;\n        this.$nextTick(()=>{\n          setTimeout(function (){\n            _this.$refs.scoll.scrollTop = 0;\n          },100)\n        })\n      },\n\n      changePackage(title){\n        console.log(title)\n      },\n      changeRentLease(item){\n        var packageName = item.packageName;\n        var mini = packageName.miniLease;\n        var max = packageName.maxLease;\n        var miniType = packageName.miniType;\n        var leaseType = miniType == \"2\"?\"个月\":\"周\";\n        this.leases = []\n        if (mini == max){\n          this.leases.push({label:mini+leaseType,value:mini})\n        }\n        if (mini != max){\n          if(this.enable('custom_rent')){\n            for (let i = mini; i <= max; i++) {\n              this.leases.push({label:i+leaseType,value:i})\n            }\n          }else {\n            this.leases.push({label:max+leaseType,value:max})\n          }\n        }\n      },\n      /**\n       * 切换规格，当切换规格的时候，分为两种情况，\n       * 第一种情况是默认的规格，这个时候resetPackageName需要为false，不重置选择的套餐\n       * 第二种情况是手动选择规格，这个时候需要触发该方法为规格下拉的点击事件。重置套餐的默认值\n       * @param title\n       * @param resetPackageName\n       */\n      changeCombinations(title,resetPackageName = true){\n        this.packageNameTitle = resetPackageName?null:this.packageNameTitle;\n        this.goodsCombinations = [];\n        for (const item of this.combinationsJsonData) {\n          var key = \"\";\n          for (let i = 1; i < 10; i++) {\n            if (!item['specification'+i]){\n              break;\n            }\n            if (key.length>0){\n              key = key +\",\"\n            }\n            key = key + item['specification'+i].name;\n          }\n          if (title == key)\n            if (this.goodsCombinations.indexOf(item.packageName.name)==-1)\n              this.goodsCombinations.push(item.packageName.name);\n        }\n      },\n      getGoodsDetail(){\n        if (!this.form.goodsId){\n          return;\n        }\n        getDetail(this.form.goodsId).then(res => {\n          this.goodsInfo = res.data.data\n          this.combinationsJsonData = JSON.parse(res.data.data.combinationsJsonData);\n          //加载套餐的下拉\n          this.changeCombinations(this.goodsCombinationTitle,false)\n          //加载规格的下拉\n          var packageName = false;\n          for (const item of this.combinationsJsonData) {\n            var key = \"\";\n            for (let i = 1; i < 10; i++) {\n              if (!item['specification'+i]){\n                break;\n              }\n              if (key.length>0){\n                key = key +\",\"\n              }\n              key = key + item['specification'+i].name;\n            }\n            if (this.combinationsJsonTitles.indexOf(key)==-1)\n              this.combinationsJsonTitles.push(key);\n            if (this.goodsCombinationTitle == key && this.packageNameTitle == item.packageName.name){\n              packageName = true;\n            }\n          }\n          //这里说明了当前订单中的商品，套餐和规格尺寸重新编辑过，导致该订单中的尺寸在商品信息中无法找到，需要重新设置\n          if (this.form.goodsId == this.param.goodsId&&(this.combinationsJsonTitles.indexOf(this.goodsCombinationTitle) == -1||!packageName)){\n            console.log(\"该商品规格尺寸已改变，请重新选择规格尺寸\")\n            this.matching = false;\n          }else{\n            this.matching = true;\n          }\n        })\n      },\n      addItemConfirm(){\n\n        if (this.addItem.money == 0){\n          Message({\n            message: \"请输入金额\",\n            type: 'error'\n          })\n          return;\n        }\n\n\n        if (!this.addItem.value){\n          Message({\n            message: \"请选择账单类型\",\n            type: 'error'\n          })\n          return;\n        }\n\n        if (parseFloat(this.param.amount)*0.9-this.form.realMoney - parseFloat(this.addItem.money)<=0){\n          var money = toFixed(parseFloat(this.param.amount)*0.9 -this.form.realMoney - parseFloat(this.addItem.money),2);\n          Message({\n            message: \"账单总金额超出了90%预授权额度的\"+(money*-1),\n            type: 'error'\n          })\n          return;\n        }\n\n        for (const bill of this.form.bills) {\n          if (bill.typeName == this.addItem.typeName&&this.addItem.type == bill.type&&bill.type == 5&&bill.orderNumber == this.addItem.orderNumber){\n            Message({\n              message: \"该账单已存在\",\n              type: 'error'\n            })\n            return;\n          }\n          if (bill.typeName == this.addItem.typeName&&this.addItem.type == bill.type&&bill.type != 5){\n            Message({\n              message: \"该账单已存在\",\n              type: 'error'\n            })\n            return;\n          }\n        }\n        this.dialogVisible = false;\n        this.addItem.first = false;\n        this.form.bills.push(this.addItem)\n        this.addItem = {\n          status:1,\n          typeName:null,\n          money:0,\n        }\n        this.sort()\n      },\n      selectItem(item){\n        Object.assign(this.addItem,item);\n      },\n      init(){\n        this.option.column[1].dicData = this.$enum.selectOpion()\n        var item = this.param.goodsCombinationJson.packageName;\n        // var item = this.$enum.defaultPlanInfo['type_'+this.form.packageType];\n        var mini = item.miniLease;\n        var max = item.maxLease;\n        var miniType = item.miniType;\n        var leaseType = miniType == \"2\"?\"个月\":\"周\";\n        if (mini == max){\n          this.option.column[2].dicData.push({label:mini+leaseType,value:mini})\n        }\n        if (mini != max){\n          for (let i = mini; i <= max; i++) {\n            this.option.column[2].dicData.push({label:i+leaseType,value:i})\n          }\n        }\n      },\n      deleteBill(index){\n        this.form.bills.splice(index,1);\n      },\n      addBill(){\n        this.dialogVisible = true;\n      },\n      editBill(index){\n        this.editItemVisible = true;\n        this.editIndex = index;\n        this.editItem = {...this.form.bills[index]};\n      },\n      /**\n       * 提交编辑\n       */\n      submit(){\n        //提交之前，先对订单进行整理\n        const order = {};\n        order.goodsCombination = JSON.stringify(this.goodsCombination)\n        order.bills = this.form.bills;\n        for (const bill of order.bills) {\n          if (bill.first){\n            bill.firstBill = 2;\n          }else {\n            bill.firstBill = 1;\n          }\n        }\n        order.goodsCombinationId = this.goodsCombination.id;\n        order.goodsId = this.form.goodsId;\n        order.id = this.param.id;\n        order.no = this.param.no;//订单编号\n        order.goodsTitle = this.goodsInfo.title//商品名称\n        order.secondHand = this.goodsInfo.secondHand;//折扣率\n        order.lease = this.form.lease;//周期\n        order.leaseType = this.goodsCombination.packageName.miniType;//周期类型\n        order.rentType = this.goodsCombination.packageName.type;//套餐类型\n        order.websitePrice = Number.parseFloat(this.goodsCombination.websitePrice);//官网价\n        order.totalPricesRate = Number.parseFloat(this.goodsInfo.totalPricesRate);//总价系数\n        order.rentPerMoney = Number.parseFloat(this.goodsCombination.rentPerMoney);//每一期租金\n        order.depositMoneyFirst = Number.parseFloat(this.goodsCombination.depositMoney);//商品押金\n        this.goodsCombination.totalPricesRate = order.totalPricesRate;\n        if (order.rentType == 1||order.rentType==2){\n          order.rentMoney = calculateRentMoney(this.goodsCombination)\n        }else{\n          order.rentMoney = calculateRentLimitMoney(this.goodsCombination,order.lease)\n        }\n        this.loading = true;\n        updateOrder(order).then(res => {\n          console.log(res)\n          this.loading = false;\n          this.isShow = false\n          this.$nextTick(() => {\n            this.end(true);\n          })\n        }).catch(res => {\n          console.log(res)\n          this.loading = false;\n        });\n      },\n      cancle(){\n        this.isShow = false\n        this.$nextTick(() => {\n          this.end(false);\n        })\n      },\n      headers(){\n        return headers()\n      },\n      closeFn () {\n        this.isShow = false\n        this.$nextTick(() => {\n          this.end(false);\n        })\n      },\n      billTypeName(bill){\n        if (bill.type == 5){\n          return \"第\"+bill.orderNumber+bill.typeName;\n        }\n        return bill.typeName;\n      },\n      handleAvatarSuccess(res, file) {\n        this.imageUrl = URL.createObjectURL(file.raw);\n      },\n      beforeAvatarUpload(file) {\n        const isJPG = file.type === 'image/jpeg';\n        const isLt2M = file.size / 1024 / 1024 < 2;\n\n        if (!isJPG) {\n          this.$message.error('上传头像图片只能是 JPG 格式!');\n        }\n        if (!isLt2M) {\n          this.$message.error('上传头像图片大小不能超过 2MB!');\n        }\n        return isJPG && isLt2M;\n      }\n    },\n  };\n</script>\n<style >\n  .title-class {\n    padding: 5px 5px !important;\n  }\n</style>\n<style lang=\"scss\" scoped=\"scoped\">\n\n  .bills {\n    display: flex;flex-direction: column;width: 100%;max-height: 240px;overflow: auto\n  }\n\n  .avatar-uploader .el-upload {\n    border: 1px dashed #d9d9d9;\n    border-radius: 6px;\n    cursor: pointer;\n    position: relative;\n    overflow: hidden;\n  }\n  .avatar-uploader .el-upload:hover {\n    border-color: #409EFF;\n  }\n  .avatar-uploader-icon {\n    font-size: 28px;\n    color: #8c939d;\n    width: 178px;\n    height: 178px;\n    line-height: 178px;\n    text-align: center;\n  }\n  .avatar {\n    width: 178px;\n    height: 178px;\n    display: block;\n  }\n  .bill_info {\n    width: 80%;\n  }\n  .bill_info :deep .el-form-item {\n    margin-bottom: 0px !important;\n  }\n  :deep .el-card__body {\n    padding-top: 10px !important;\n  }\n  :deep .avue-dialog {\n    margin-top: 15vh !important;\n\n    :deep .el-dialog__wrapper {\n      text-align: center;\n      white-space: nowrap;\n      overflow: auto;\n      &:after {\n        content: \"\";\n        display: inline-block;\n        vertical-align: middle;\n        height: 100%;\n      }\n      .el-dialog {\n        margin: 30px auto !important;\n        display: inline-block;\n        vertical-align: middle;\n        text-align: center;\n        white-space: normal;\n      }\n    }\n  }\n</style>\n"]}]}